---
- name: Deploy UBI Web Application with Custom Content
  hosts: localhost
  gather_facts: no
  vars:
    namespace: "production-app"
    app_name: "web-frontend"
    image_name: "registry.access.redhat.com/ubi8/httpd-24:latest"
    replicas: 2
  
  tasks:
    - name: Create or switch to namespace
      command: oc new-project {{ namespace }}
      register: project_create
      failed_when: false
      changed_when: "'Now using project' in project_create.stdout"

    - name: Switch to project if already exists
      command: oc project {{ namespace }}
      when: project_create.rc != 0
      changed_when: false

    - name: Create ConfigMap with index.html
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ app_name }}-content"
            namespace: "{{ namespace }}"
          data:
            index.html: |
              <!DOCTYPE html>
              <html>
              <head>
                  <title>OpenShift Demo</title>
                  <style>
                      body { 
                          font-family: Arial, sans-serif; 
                          text-align: center; 
                          padding: 50px; 
                          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                          color: white;
                      }
                      .container {
                          background: rgba(255,255,255,0.1);
                          padding: 40px;
                          border-radius: 10px;
                          max-width: 600px;
                          margin: 0 auto;
                      }
                      h1 { color: #fff; margin-bottom: 20px; }
                      p { font-size: 18px; line-height: 1.6; }
                  </style>
              </head>
              <body>
                  <div class="container">
                      <h1>ðŸš€ Welcome to OpenShift!</h1>
                      <p>This application is deployed using <strong>Ansible automation</strong></p>
                      <p>Running on <strong>UBI (Universal Base Image)</strong></p>
                      <p>Namespace: {{ namespace }}</p>
                      <p>Application: {{ app_name }}</p>
                  </div>
              </body>
              </html>

    - name: Create deployment with volume mount
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: "{{ app_name }}"
            namespace: "{{ namespace }}"
            labels:
              app: "{{ app_name }}"
          spec:
            replicas: "{{ replicas }}"
            selector:
              matchLabels:
                app: "{{ app_name }}"
            template:
              metadata:
                labels:
                  app: "{{ app_name }}"
              spec:
                containers:
                  - name: "{{ app_name }}"
                    image: "{{ image_name }}"
                    ports:
                      - containerPort: 8080
                        protocol: TCP
                    resources:
                      requests:
                        memory: "128Mi"
                        cpu: "50m"
                      limits:
                        memory: "256Mi"
                        cpu: "200m"
                    volumeMounts:
                      - name: content
                        mountPath: /var/www/html/index.html
                        subPath: index.html
                    startupProbe:
                      httpGet:
                        path: /
                        port: 8080
                      initialDelaySeconds: 10
                      periodSeconds: 5
                      failureThreshold: 12
                    livenessProbe:
                      httpGet:
                        path: /
                        port: 8080
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      failureThreshold: 3
                    readinessProbe:
                      httpGet:
                        path: /
                        port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 5
                      failureThreshold: 3
                volumes:
                  - name: content
                    configMap:
                      name: "{{ app_name }}-content"

    - name: Create service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ app_name }}-service"
            namespace: "{{ namespace }}"
          spec:
            selector:
              app: "{{ app_name }}"
            ports:
              - protocol: TCP
                port: 80
                targetPort: 8080

    - name: Create route
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: "{{ app_name }}-route"
            namespace: "{{ namespace }}"
          spec:
            to:
              kind: Service
              name: "{{ app_name }}-service"
            port:
              targetPort: 8080

    - name: Get route URL
      command: oc get route {{ app_name }}-route -n {{ namespace }} -o jsonpath='{.spec.host}'
      register: route_url
      changed_when: false

    - name: Display application URL
      debug:
        msg:
          - "=================================="
          - "Deployment Created Successfully"
          - "Application: {{ app_name }}"
          - "Namespace: {{ namespace }}"
          - "Application URL: http://{{ route_url.stdout }}"
          - "=================================="
